<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Bart WalkThrough | TensorGoose</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Bart WalkThrough" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A journey through the forward pass" />
<meta property="og:description" content="A journey through the forward pass" />
<link rel="canonical" href="https://sshleifer.github.io/blog_v2/jupyter/2020/03/06/bart.html" />
<meta property="og:url" content="https://sshleifer.github.io/blog_v2/jupyter/2020/03/06/bart.html" />
<meta property="og:site_name" content="TensorGoose" />
<meta property="og:image" content="https://sshleifer.github.io/blog_v2/images/chart-preview.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-03-06T00:00:00-06:00" />
<script type="application/ld+json">
{"datePublished":"2020-03-06T00:00:00-06:00","headline":"Bart WalkThrough","image":"https://sshleifer.github.io/blog_v2/images/chart-preview.png","description":"A journey through the forward pass","mainEntityOfPage":{"@type":"WebPage","@id":"https://sshleifer.github.io/blog_v2/jupyter/2020/03/06/bart.html"},"@type":"BlogPosting","url":"https://sshleifer.github.io/blog_v2/jupyter/2020/03/06/bart.html","dateModified":"2020-03-06T00:00:00-06:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog_v2/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://sshleifer.github.io/blog_v2/feed.xml" title="TensorGoose" /><link rel="shortcut icon" type="image/x-icon" href="/blog_v2/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Bart WalkThrough | TensorGoose</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Bart WalkThrough" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A journey through the forward pass" />
<meta property="og:description" content="A journey through the forward pass" />
<link rel="canonical" href="https://sshleifer.github.io/blog_v2/jupyter/2020/03/06/bart.html" />
<meta property="og:url" content="https://sshleifer.github.io/blog_v2/jupyter/2020/03/06/bart.html" />
<meta property="og:site_name" content="TensorGoose" />
<meta property="og:image" content="https://sshleifer.github.io/blog_v2/images/chart-preview.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-03-06T00:00:00-06:00" />
<script type="application/ld+json">
{"datePublished":"2020-03-06T00:00:00-06:00","headline":"Bart WalkThrough","image":"https://sshleifer.github.io/blog_v2/images/chart-preview.png","description":"A journey through the forward pass","mainEntityOfPage":{"@type":"WebPage","@id":"https://sshleifer.github.io/blog_v2/jupyter/2020/03/06/bart.html"},"@type":"BlogPosting","url":"https://sshleifer.github.io/blog_v2/jupyter/2020/03/06/bart.html","dateModified":"2020-03-06T00:00:00-06:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://sshleifer.github.io/blog_v2/feed.xml" title="TensorGoose" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    // remove paragraph tags in rendered toc (happens from notebooks)
    var toctags = document.querySelectorAll(".toc-entry")
    toctags.forEach(e => (e.firstElementChild.innerText = e.firstElementChild.innerText.replace('¶', '')))
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog_v2/">TensorGoose</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog_v2/about/">About Me</a><a class="page-link" href="/blog_v2/search/">Search</a><a class="page-link" href="/blog_v2/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Bart WalkThrough</h1><p class="page-description">A journey through the forward pass</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-03-06T00:00:00-06:00" itemprop="datePublished">
        Mar 6, 2020
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      38 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog_v2/categories/#jupyter">jupyter</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/sshleifer/blog_v2/tree/master/_notebooks/2020-03-06-bart.ipynb" role="button">
<img class="notebook-badge-image" src="/blog_v2/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div><div class="px-2">
    <a href="https://colab.research.google.com/github/sshleifer/blog_v2/blob/master/_notebooks/2020-03-06-bart.ipynb">
        <img class="notebook-badge-image" src="/blog_v2/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h3"><a href="#Seq2Seq-Pretraining">Seq2Seq Pretraining </a></li>
<li class="toc-entry toc-h3"><a href="#Background:-Bert-vs.-GPT2">Background: Bert vs. GPT2 </a></li>
<li class="toc-entry toc-h3"><a href="#Encoder-Decoder">Encoder-Decoder </a></li>
<li class="toc-entry toc-h3"><a href="#Summarization">Summarization </a></li>
<li class="toc-entry toc-h3"><a href="#BartForConditionalGeneration">BartForConditionalGeneration </a></li>
<li class="toc-entry toc-h2"><a href="#Incremental-Decoding">Incremental Decoding </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Partially-caching-k-and-v-in-DecoderLayer">Partially caching k and v in DecoderLayer </a></li>
<li class="toc-entry toc-h3"><a href="#Conclusion">Conclusion </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Footnotes">Footnotes </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Cut">Cut </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-03-06-bart.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Seq2Seq-Pretraining">
<a class="anchor" href="#Seq2Seq-Pretraining" aria-hidden="true"><span class="octicon octicon-link"></span></a>Seq2Seq Pretraining<a class="anchor-link" href="#Seq2Seq-Pretraining"> </a>
</h3>
<p>In October 2019, teams from Microsoft, Google and Facebook independently published three new transformer papers: UniLM, T5 and Bart. All three papers analyze found that they achieve better downstream performance on generation tasks if they (a) replace Bert's bidirectional architecture with a seq2seq architecture and (b) Bert's fill-in-the blank cloze task with a more complicated mix of pretraining tasks.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now lets dig deeper into the big Seq2Seq pretraining idea, then dive into some interesting parts of the <code>BartForConditionalGeneration</code> code.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Background:-Bert-vs.-GPT2">
<a class="anchor" href="#Background:-Bert-vs.-GPT2" aria-hidden="true"><span class="octicon octicon-link"></span></a>Background: Bert vs. GPT2<a class="anchor-link" href="#Background:-Bert-vs.-GPT2"> </a>
</h3>
<p>As the Bart authors' write,</p>
<blockquote>
<p>(Bart) can be seen as generalizing Bert (due to the bidirectional encoder) and GPT (with the left to right decoder).</p>
</blockquote>
<p>Bert is pretrained to try to predict masked tokens, and uses the whole sequence to get enough info to make a good guess. This is good for tasks where the prediction at position <code>i</code> is allowed to utilize information from positions after <code>i</code>, but less useful for tasks where you are not, like text generation, where you generate the next word conditional on the previously generated words.</p>
<p>In code, the idea of "what information you can use when predicting the token at position <code>i</code>" is controlled by a parameter called <code>attention_mask</code><sup class="footnote-ref" id="fnref-2"><a href="#fn-2">1</a></sup>.</p>
<blockquote>
<p>Note: In this post, we show attention masks in grids where each row <code>y</code> represents an output token, and each column <code>x</code> represents an input token. If the square at <code>(y3, x4)</code> is black. It means that our prediction for <code>y3</code> is allowed to utilize information from <code>x4</code>. During pretraining, <code>x</code> would be the corrupted document, and <code>y</code> would be the original.</p>
</blockquote>
<p>Bert's "Fully-visible" <code>attention_mask</code> is boring:
<img src="/blog_v2/images/copied_from_nb/./bert_mac_small.jpg" alt=""></p>
<div class="footnotes">
<hr>
<ol>
<li id="fn-2"><p>the same parameter that is used to make model predictions invariant to pad tokens.<a href="#fnref-2" class="footnote">↩</a></p></li>
</ol>
</div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>GPT2, meanwhile, is pretrained to predict the next word.
This makes it good for producing generations, where there aren't future tokens to consider, but less useful for other downstream tasks where the whole sentence is utilized.</p>
<p>Here is the <code>attention_mask</code> for GPT2:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/blog_v2/images/copied_from_nb/./gpt2_simple_mask.jpg" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<!-- All together, now:
![](/blog_v2/images/copied_from_nb/./t5_mask_diagram.png) -->
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Encoder-Decoder">
<a class="anchor" href="#Encoder-Decoder" aria-hidden="true"><span class="octicon octicon-link"></span></a>Encoder-Decoder<a class="anchor-link" href="#Encoder-Decoder"> </a>
</h3>
<p>Our new friends get the best of both worlds!</p>
<p>The encoder is bidirectional  - each token's attention can attend to every other token in the input sequence, while the decoder, which will ultimately have to perform generation, is causal like GPT2.</p>
<p><img src="/blog_v2/images/copied_from_nb/./causal_with_prefix.jpg" alt=""></p>
<p>We can think about this <code>attention_mask</code> as smushing together our previous two attention masks, or "Causal Mask  with a fully visible prefix" in fancier terms.<sup class="footnote-ref" id="fnref-4"><a href="#fn-4">1</a></sup></p>
<div class="footnotes">
<hr>
<ol>
<li id="fn-4"><p>The indices dont line up perfectly for the smush to work, but tokens 1 and 2 are the fully visible prefix (or the input to the encoder) and tokens 3,4,5 are the causally masked suffix (or inputs to the decoder). In summarization terms, you could imagine tokens 1 and 2 as the article, and we generate tokens 3-5 auto-regressively.<a href="#fnref-4" class="footnote">↩</a></p></li>
</ol>
</div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we understand the big idea, we are going to focus on using Bart for Summarization.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/blog_v2/images/copied_from_nb/./t5_mask_diagram.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Summarization">
<a class="anchor" href="#Summarization" aria-hidden="true"><span class="octicon octicon-link"></span></a>Summarization<a class="anchor-link" href="#Summarization"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>During summarization finetuning, the <code>source</code> sequence is the document we want to summarize, and the <code>target</code> sequence is a ground truth summary.
The Seq2Seq attention pattern is therefore very well suited to summarization and other conditional generation tasks. We are allowed to attend to the whole source document, but as we write your summary, one word at a time, we can only consider what we've already written. The numbers confirm this: all the new fancy guys do a lot better than the old less-fancy guys on the CNN/Daily Mail summarization task.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-hide </span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="c1">#df = pd.read_csv('tab1.csv', index_col=0)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">rouge2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'Bart'</span><span class="p">:</span> <span class="mf">21.28</span><span class="p">,</span>
 <span class="s1">'UniLM'</span><span class="p">:</span> <span class="mf">20.3</span><span class="p">,</span>
 <span class="s1">'BertSumABS'</span><span class="p">:</span> <span class="mf">19.39</span><span class="p">,</span>
 <span class="s1">'T5-base'</span><span class="p">:</span> <span class="mf">20.34</span><span class="p">,</span>
 <span class="s1">'T5-11B'</span><span class="p">:</span> <span class="mf">21.55</span><span class="p">,</span>
 <span class="s1">'TransformerAbs'</span><span class="p">:</span> <span class="mf">17.76</span><span class="p">},</span>
<span class="n">model_size</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'Bart'</span><span class="p">:</span> <span class="s2">"406 M"</span><span class="p">,</span>
 <span class="s1">'UniLM'</span><span class="p">:</span> <span class="s2">"340 M"</span><span class="p">,</span>
 <span class="s1">'BertSumABS'</span><span class="p">:</span> <span class="s2">"220 M"</span><span class="p">,</span>
 <span class="s1">'T5-base'</span><span class="p">:</span> <span class="s2">"770 M"</span><span class="p">,</span>
 <span class="s1">'T5-11B'</span><span class="p">:</span> <span class="s2">"11 B"</span><span class="p">,</span>
 <span class="s1">'TransformerAbs'</span><span class="p">:</span> <span class="s2">"200M"</span><span class="p">}</span>
    <span class="p">))</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">'rouge2'</span><span class="p">)</span>

<span class="n">df</span><span class="p">[</span><span class="s1">'Pretraining'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'None'</span><span class="p">,</span> <span class="s1">'Encoder'</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'Seq2Seq'</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span>
<span class="n">df</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">'Model'</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">'model_size'</span><span class="p">:</span> <span class="s1">'Model Size'</span><span class="p">,</span> <span class="s1">'rouge2'</span><span class="p">:</span> <span class="s1">'Rouge-2'</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Rouge-2</th>
      <th>Model Size</th>
      <th>Pretraining</th>
    </tr>
    <tr>
      <th>Model</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>TransformerAbs</th>
      <td>17.76</td>
      <td>200M</td>
      <td>None</td>
    </tr>
    <tr>
      <th>BertSumABS</th>
      <td>19.39</td>
      <td>220 M</td>
      <td>Encoder</td>
    </tr>
    <tr>
      <th>UniLM</th>
      <td>20.30</td>
      <td>340 M</td>
      <td>Seq2Seq</td>
    </tr>
    <tr>
      <th>T5-base</th>
      <td>20.34</td>
      <td>770 M</td>
      <td>Seq2Seq</td>
    </tr>
    <tr>
      <th>Bart</th>
      <td>21.28</td>
      <td>406 M</td>
      <td>Seq2Seq</td>
    </tr>
    <tr>
      <th>T5-11B</th>
      <td>21.55</td>
      <td>11 B</td>
      <td>Seq2Seq</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<!-- I start with this not to say that the researchers are lame, but that they were all discovering a very cool idea at the same time. In the following table, you can see that, at least for summarization, it is important to pretrain with a bidirectional encoder and causal decoder: (The UniLM `prefix_lm` is equivalent [^3]) -->

<p><code>BertSumABS</code> [^2] , uses Seq2Seq architecture but doesn't pretrain the decoder.</p>
<p>Shortly after these papers were released, people wanted to use them in <code>transformers</code>, with lots of attention dedicated to Bart, which we introduce today.</p>
<p>Bart tries out crazy pretraining tasks that you can only do with a seq2seq architecture. Since "Inputs to the encoder need not be aligned with decoder outputs, allowing arbitary noise transformations." They use a pretraining task called Text Infilling, where you
replace a <strong>span</strong> of text with a single mask token. This span can be of any length, so the model also must learn how many tokens to generate.</p>
<p>There is also another trick in Bart: each decoder layer performs cross over the final hidden state of the encoder output. This presumably nudges Bart towards generating summaries that are closely connected to the original (encoded) text.</p>
<p>And now, lets use <code>BartForConditionalGeneration</code> to summarize a boring article about tennis from the CNN dataset.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="BartForConditionalGeneration">
<a class="anchor" href="#BartForConditionalGeneration" aria-hidden="true"><span class="octicon octicon-link"></span></a><code>BartForConditionalGeneration</code><a class="anchor-link" href="#BartForConditionalGeneration"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>imports</strong></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-hide</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">transformers</span>  <span class="c1">#  Installed from source at commit e03129ad</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">BartTokenizer</span><span class="p">,</span> <span class="n">BartForConditionalGeneration</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">Markdown</span>

<span class="n">torch_device</span> <span class="o">=</span> <span class="s1">'cuda'</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">'cpu'</span>
<span class="k">def</span> <span class="nf">print_80_per_line</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">80</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">txt</span><span class="p">),</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">txt</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">])</span>
    <span class="k">return</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>transformers installed from source
-e git+git@github.com:sshleifer/transformers_fork.git@4f9d1f20c3950d81e097c1409d8165a2577fcf32#egg=transformers
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description" open="">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-show</span>
<span class="n">LONG_BORING_TENNIS_ARTICLE</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2"> Andy Murray  came close to giving himself some extra preparation time for his w</span>
<span class="s2">edding next week before ensuring that he still has unfinished tennis business to</span>
<span class="s2"> attend to. The world No 4 is into the semi-finals of the Miami Open, but not be</span>
<span class="s2">fore getting a scare from 21 year-old Austrian Dominic Thiem, who pushed him to </span>
<span class="s2">4-4 in the second set before going down 3-6 6-4, 6-1 in an hour and three quarte</span>
<span class="s2">rs. Murray was awaiting the winner from the last eight match between Tomas Berdy</span>
<span class="s2">ch and Argentina's Juan Monaco. Prior to this tournament Thiem lost in the secon</span>
<span class="s2">d round of a Challenger event to soon-to-be new Brit Aljaz Bedene. Andy Murray p</span>
<span class="s2">umps his first after defeating Dominic Thiem to reach the Miami Open semi finals</span>
<span class="s2"> . Muray throws his sweatband into the crowd after completing a 3-6, 6-4, 6-1 vi</span>
<span class="s2">ctory in Florida . Murray shakes hands with Thiem who he described as a 'strong </span>
<span class="s2">guy' after the game . And Murray has a fairly simple message for any of his fell</span>
<span class="s2">ow British tennis players who might be agitated about his imminent arrival into </span>
<span class="s2">the home ranks: don't complain. Instead the British No 1 believes his colleagues</span>
<span class="s2"> should use the assimilation of the world number 83, originally from Slovenia, a</span>
<span class="s2">s motivation to better themselves. At present any grumbles are happening in priv</span>
<span class="s2">ate, and Bedene's present ineligibility for the Davis Cup team has made it less </span>
<span class="s2">of an issue, although that could change if his appeal to play is allowed by the </span>
<span class="s2">International Tennis Federation. Murray thinks anyone questioning the move, now </span>
<span class="s2">it has become official, would be better working on getting their ranking closer </span>
<span class="s2">to his. 'If he was 500 in the world they wouldn't be that fussed about it but ob</span>
<span class="s2">viously he threatens their position a bit,' said the 27 year-old Scot. ' and he'</span>
<span class="s2">s obviously the British number two, comfortably. 'So they can complain but the b</span>
<span class="s2">est thing to do is use it in the right way and accept it for what it is, and try</span>
<span class="s2"> to use it as motivation whether they agree with it or not. He's British now so </span>
<span class="s2">they've just got to deal with it. Murray stretches for a return after starting h</span>
<span class="s2">is quarter final match slowly on the show court . Thiem held nothing back as he </span>
<span class="s2">raced through the opening set, winning it 6-3 with a single break . The young Au</span>
<span class="s2">strian is considered to be one of the hottest prospects on the ATP Tour . 'I wou</span>
<span class="s2">ld hope that all the guys who are below him now like James (Ward) , Kyle (Edmund</span>
<span class="s2">) , Liam (Broady) they will use it as motivation. If he becomes eligible for Dav</span>
<span class="s2">is Cup then those guys are going to have to prove themselves. 'It can only be se</span>
<span class="s2">en as a positive for those guys using it to try to get better. He's a good playe</span>
<span class="s2">r but so are James and Kyle and Liam has improved. Aljaz is there, he's on the t</span>
<span class="s2">our every week, the other guys aren't quite there yet.' For the first time Murra</span>
<span class="s2">y, who has an encyclopaedic knowledge of the top 100, gave his opinion of Bedene</span>
<span class="s2">: 'He's a good player with a very good serve. He's a legitimate top 100 player, </span>
<span class="s2">when he plays Challengers he's there or thereabouts, when he plays on the main t</span>
<span class="s2">our he wins matches, it's not like he turns up and always loses in the first rou</span>
<span class="s2">nd. Murray's fiancee was once again watching from the stands shaded by a huge br</span>
<span class="s2">immed hat . Kim Sears flashes her enormous diamond engagement ring while watchin</span>
<span class="s2">g her beau on court . 'He had a bad injury last year (wrist) but has recovered w</span>
<span class="s2">ell. I would imagine he would keep moving up the rankings although I don't know </span>
<span class="s2">exactly how high he can go. I've practised with him a couple of times, I haven't</span>
<span class="s2"> seen him play loads, but when you serve as well as he does it helps. I would im</span>
<span class="s2">agine he' s going to be comfortably in the top 70 or 80 in the world for a while</span>
<span class="s2">.' It is understood the Lawn Tennis Association will give background support to </span>
<span class="s2">his case regarding the Davis Cup but have made it clear that the onus is on him </span>
<span class="s2">to lead the way. An official statement said: 'To have another player in the men'</span>
<span class="s2">s top 100 is clearly a positive thing for British tennis and so we very much wel</span>
<span class="s2">come Aljaz's change in citizenship.' The last comparable switch came twenty year</span>
<span class="s2">s ago when Greg Rusedski arrived from Canada. It was by no means universally pop</span>
<span class="s2">ular but, like Bedene, he pledged that he was in for the long haul and, in fairn</span>
<span class="s2">ess to him, he proved true to his word. Loising the first set shocked Murray int</span>
<span class="s2">o life as he raced to a commanding lead in the second . The No 3 seed sent over </span>
<span class="s2">a few glaring looks towards his team before winning the second set . Murray had </span>
<span class="s2">to put such matters aside as he tackled the unusually talented Thiem, a delight </span>
<span class="s2">to watch. Coached by Boris Becker's veteran mentor Gunter Bresnik, he slightly r</span>
<span class="s2">esembles Andy Roddick and hits with similar power but more elegance. His single </span>
<span class="s2">handed backhand is a thing of rare beauty. However, he has had a mediocre season</span>
<span class="s2"> coming into this event and there was little to forewarn of his glorious shotmak</span>
<span class="s2">ing that seemed to catch Murray unawares early on. The world No 4 looked to have</span>
<span class="s2"> worked him out in the second, but then suffered one of his periopdic mental lap</span>
<span class="s2">ses and let him back in from 4-1 before closing it out with a break. After break</span>
<span class="s2">ing him for 3-1 in the decider the Austrian whirlwind burnt itself out. 'He's a </span>
<span class="s2">strong guy who hits the ball hard and it became a very physical match,' said Mur</span>
<span class="s2">ray. Murray was presented with a celebratory cake after winning his 500th match </span>
<span class="s2">in the previous round .</span>
<span class="s2">"""</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">BartTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">'bart-large-cnn'</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">BartForConditionalGeneration</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">'bart-large-cnn'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">article_input_ids</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_encode_plus</span><span class="p">([</span><span class="n">LONG_BORING_TENNIS_ARTICLE</span><span class="p">],</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s1">'pt'</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">1024</span><span class="p">)[</span><span class="s1">'input_ids'</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch_device</span><span class="p">)</span>
<span class="n">summary_ids</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">article_input_ids</span><span class="p">,</span> <span class="n">num_beams</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">length_penalty</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                             <span class="n">max_length</span><span class="o">=</span><span class="mi">140</span><span class="p">,</span> <span class="n">min_len</span><span class="o">=</span><span class="mi">55</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">summary_txt</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">summary_ids</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="s1">'&gt; **Summary:'</span><span class="o">+</span><span class="n">summary_txt</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<blockquote>
<p><strong>Summary:</strong> Andy Murray beat Dominic Thiem 3-6, 6-4, 6-1 in the Miami Open. The world No 4 is into the semi-finals of the tournament in Florida. Murray was awaiting the winner from the last eight match between Tomas Berdych and Argentina's Juan Monaco. Thiem lost in the second round of a Challenger event to Aljaz Bedene.</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description" open="">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-show</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">GPT2LMHeadModel</span><span class="p">,</span> <span class="n">GPT2Tokenizer</span>
<span class="n">gpt2_tok</span> <span class="o">=</span> <span class="n">GPT2Tokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">'gpt2'</span><span class="p">)</span>
<span class="n">gpt2_model</span> <span class="o">=</span> <span class="n">GPT2LMHeadModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">'gpt2'</span><span class="p">,</span> <span class="n">output_past</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">enc</span> <span class="o">=</span> <span class="n">gpt2_tok</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">LONG_BORING_TENNIS_ARTICLE</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">1024</span><span class="o">-</span><span class="mi">155</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s1">'pt'</span><span class="p">)</span>
<span class="n">summary_ids</span> <span class="o">=</span> <span class="n">gpt2_model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">do_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">source</span><span class="p">,</span> <span class="n">generated</span> <span class="o">=</span> <span class="n">gpt2_tok</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">summary_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"An official statement said:"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>GPT2 (which in fairness is not finetuned for summarization) cannot really continue the tennis article sensically and can't generate past 1024 tokens.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="s1">'&gt; **GPT2:** '</span> <span class="o">+</span> <span class="n">generated</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<blockquote>
<p><strong>GPT2:</strong>  'To have a player like James Ward, Kyle Edmund, Liam Broady and Aljaz Bedene in the top 100 is a huge achievement for the Lawn Tennis Association. The Lawn Tennis Association is committed to the development of the sport and the development of the sport's players. The Lawn Tennis Association is committed to the development of the sport and the development of the sport's players. The Lawn Tennis Association is committed to the development of the sport and the development of the sport's players. The Lawn Tennis Association is committed to the development of the sport and the development of the sport's players. The Lawn Tennis Association is committed to the development of the sport and the development of the sport's players. The Lawn Tennis Association is committed to the development of the sport and the development of the</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>More importantly, these snippets show that even though <code>BartForConditionalGeneration</code> is a seq2seq model, and <code>GPT2LMHeadModel</code> is not, they can invoked in similar ways for generation.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<div class="flash">
    <svg class="octicon octicon-info" viewbox="0 0 14 16" version="1.1" width="14" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 01-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 01-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg>
    <strong>Note: </strong>The same correspondence exists between <code>BartForSequenceClassification</code>  and all the other <code>*ForSequenceClassification</code> in <code>transformers</code> -- they only require one argument: <code>input_ids</code>.
</div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The full signature, however, is a little more complex.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_ids</span><span class="p">,</span>
    <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># ignored pad tokens in input_ids</span>
    <span class="n">decoder_input_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># make these if not supplied</span>
    <span class="n">decoder_padding_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># ignored pad tokens in decoder_input_ids</span>
    <span class="n">decoder_causal_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># Ignore future tokens in decoder_input_ids</span>
<span class="p">):</span>
</pre></div>
<p>During summarization finetuning, or seq2seq pretraining, we need to pass <code>decoder_input_ids</code>. (the masks will be made for you if you dont supply them).</p>
<p>When we're not, like in a classification context, you can safely ignore all the decoder kwargs and <code>BartModel</code> will make them for you<sup class="footnote-ref" id="fnref-5"><a href="#fn-5">1</a></sup></p>
<div class="footnotes">
<hr>
<ol>
<li id="fn-5"><p>How? by taking the input_ids (movie review) and shifting them to the right. Random, I know. The authors' <a href="https://github.com/pytorch/fairseq/issues/1389">motivation</a> for the shift-right trick was to facilitate teacher forcing during pre-training, and now that the model has been trained on 64 TPUs for 12 weeks to process this input format, we continue the pattern during inference, but hide it inside the forward method.<a href="#fnref-5" class="footnote">↩</a></p></li>
</ol>
</div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Incremental-Decoding">
<a class="anchor" href="#Incremental-Decoding" aria-hidden="true"><span class="octicon octicon-link"></span></a>Incremental Decoding<a class="anchor-link" href="#Incremental-Decoding"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When I first read the fairseq code, there was a function called <code>make_generation_fast</code> which didnt do much besides catch my eye. What an exciting name! 
Anyways, here is a really slow (pseudocode) way to greedily generate summaries</p>
<div class="highlight"><pre><span></span><span class="n">output_tokens</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
     <span class="n">encoder_hidden_state</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">article_input_ids</span><span class="p">)</span>
     <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">encoder_hidden_state</span><span class="p">,</span> <span class="n">output_tokens</span><span class="p">)</span>
     <span class="n">next_word</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
     <span class="n">output_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_word</span><span class="p">)</span>
     <span class="k">if</span> <span class="n">next_word</span> <span class="o">==</span> <span class="n">eos</span><span class="p">:</span> <span class="k">break</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can just cache the first step and save half the compute</p>
<div class="highlight"><pre><span></span><span class="n">output_tokens</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">encoder_hidden_state</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">article_input_ids</span><span class="p">)</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
     <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">encoder_hidden_state</span><span class="p">,</span> <span class="n">output_tokens</span><span class="p">)</span>
     <span class="n">next_word</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>

     <span class="n">output_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_word</span><span class="p">)</span>
     <span class="k">if</span> <span class="n">next_word</span> <span class="o">==</span> <span class="n">eos</span><span class="p">:</span> <span class="k">break</span>
</pre></div>
<p>Easy peasy, sorry for wasting your time. Here comes the fun one</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Partially-caching-k-and-v-in-DecoderLayer">
<a class="anchor" href="#Partially-caching-k-and-v-in-DecoderLayer" aria-hidden="true"><span class="octicon octicon-link"></span></a>Partially caching k and v in <code>DecoderLayer</code><a class="anchor-link" href="#Partially-caching-k-and-v-in-DecoderLayer"> </a>
</h3>
<p>Here is some pseudocode for attention without all the reshapes and heads and masks and scaling.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SimplifiedAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Wq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Wk</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Wv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wq</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wk</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> 
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wv</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">matmul_qk</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">attention_weights</span> <span class="o">=</span> <span class="n">matmul_qk</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">attention_weights</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<p>Now lets glimpse at the callers inside bart's <code>DecoderLayer</code>:
(LayerNorms and dropouts deleted for simplicity). Here's some more pseudocode</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SimplifiedDecoderLayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span> <span class="o">=</span> <span class="n">SimplifiedAttention</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_attn</span> <span class="o">=</span> <span class="n">SimplifiedAttention</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">last_encoder_hidden_state</span><span class="p">,</span> <span class="o">*</span><span class="n">masks_etc</span><span class="p">):</span>
         <span class="c1"># x shape `(batch_size, tokens_generated_so_far, embed_dim)`</span>
         <span class="c1"># x comes from decoder</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">x</span><span class="p">)</span> <span class="c1"># pay attention to somebody else for a change!</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_attn</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="n">last_encoder_hidden_state</span><span class="p">,</span>  <span class="c1"># could be None</span>
            <span class="n">value</span><span class="o">=</span><span class="n">last_encoder_hidden_state</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>
</pre></div>
<p>What did we learn?</p>
<ul>
<li>In <code>encoder_attention</code>, we can cache everything that doesn't depend on q, namely these outputs
<pre><code>      k = self.Wk(k) 
      v = self.Wv(v)</code></pre>
</li>
</ul>
<p>The more exciting optimization is that in <code>self_attn</code>, we can cache the part of k,v that depends on 
<code>x[:, :1]</code> the tokens we've already generated. Then each time through the generation loop, we only pass in <code>x[:, :-1]</code> and apply concatenation:</p>
<div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">past_key</span><span class="p">,</span> <span class="n">new_k</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="s1">'seq_len'</span><span class="p">)</span> <span class="c1"># the seq_len dimension, </span>
<span class="n">v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">past_value</span><span class="p">,</span> <span class="n">new_v</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="s1">'seq_len'</span><span class="p">)</span>
</pre></div>
<p><code>TODO(SS): Why cant we cache part of q?</code></p>
<p>Of the 8 <code>F.linear</code> ops performed by each DecoderLayer was doing, we've managed to completely cache 2 of them, and almost completely cache 2 more. Overall, we chop off about 40% of the runtime. <code>TODO(SS): verify</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Conclusion">
<a class="anchor" href="#Conclusion" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusion<a class="anchor-link" href="#Conclusion"> </a>
</h3>
<p>Our first release of <code>BartModel</code> prioritized moving quickly and keeping the code simple. As a result, our implementation is about 30\% slower and uses more memory than the authors'. Stay tuned for episode 2 of this series, where we try to close the gap.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Footnotes">
<a class="anchor" href="#Footnotes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Footnotes<a class="anchor-link" href="#Footnotes"> </a>
</h2>
<div class="footnotes">
<hr>
<ol></ol>
</div>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">print_80_per_line</span><span class="p">(</span><span class="s2">" Andy Murray  came close to giving himself some extra preparation time for his wedding next week before ensuring that he still has unfinished tennis business to attend to. The world No 4 is into the semi-finals of the Miami Open, but not before getting a scare from 21 year-old Austrian Dominic Thiem, who pushed him to 4-4 in the second set before going down 3-6 6-4, 6-1 in an hour and three quarters. Murray was awaiting the winner from the last eight match between Tomas Berdych and Argentina's Juan Monaco. Prior to this tournament Thiem lost in the second round of a Challenger event to soon-to-be new Brit Aljaz Bedene. Andy Murray pumps his first after defeating Dominic Thiem to reach the Miami Open semi finals . Muray throws his sweatband into the crowd after completing a 3-6, 6-4, 6-1 victory in Florida . Murray shakes hands with Thiem who he described as a 'strong guy' after the game . And Murray has a fairly simple message for any of his fellow British tennis players who might be agitated about his imminent arrival into the home ranks: don't complain. Instead the British No 1 believes his colleagues should use the assimilation of the world number 83, originally from Slovenia, as motivation to better themselves. At present any grumbles are happening in private, and Bedene's present ineligibility for the Davis Cup team has made it less of an issue, although that could change if his appeal to play is allowed by the International Tennis Federation. Murray thinks anyone questioning the move, now it has become official, would be better working on getting their ranking closer to his. 'If he was 500 in the world they wouldn't be that fussed about it but obviously he threatens their position a bit,' said the 27 year-old Scot. ' and he's obviously the British number two, comfortably. 'So they can complain but the best thing to do is use it in the right way and accept it for what it is, and try to use it as motivation whether they agree with it or not. He's British now so they've just got to deal with it. Murray stretches for a return after starting his quarter final match slowly on the show court . Thiem held nothing back as he raced through the opening set, winning it 6-3 with a single break . The young Austrian is considered to be one of the hottest prospects on the ATP Tour . 'I would hope that all the guys who are below him now like James (Ward) , Kyle (Edmund) , Liam (Broady) they will use it as motivation. If he becomes eligible for Davis Cup then those guys are going to have to prove themselves. 'It can only be seen as a positive for those guys using it to try to get better. He's a good player but so are James and Kyle and Liam has improved. Aljaz is there, he's on the tour every week, the other guys aren't quite there yet.' For the first time Murray, who has an encyclopaedic knowledge of the top 100, gave his opinion of Bedene: 'He's a good player with a very good serve. He's a legitimate top 100 player, when he plays Challengers he's there or thereabouts, when he plays on the main tour he wins matches, it's not like he turns up and always loses in the first round. Murray's fiancee was once again watching from the stands shaded by a huge brimmed hat . Kim Sears flashes her enormous diamond engagement ring while watching her beau on court . 'He had a bad injury last year (wrist) but has recovered well. I would imagine he would keep moving up the rankings although I don't know exactly how high he can go. I've practised with him a couple of times, I haven't seen him play loads, but when you serve as well as he does it helps. I would imagine he' s going to be comfortably in the top 70 or 80 in the world for a while.' It is understood the Lawn Tennis Association will give background support to his case regarding the Davis Cup but have made it clear that the onus is on him to lead the way. An official statement said: 'To have another player in the men's top 100 is clearly a positive thing for British tennis and so we very much welcome Aljaz's change in citizenship.' The last comparable switch came twenty years ago when Greg Rusedski arrived from Canada. It was by no means universally popular but, like Bedene, he pledged that he was in for the long haul and, in fairness to him, he proved true to his word. Loising the first set shocked Murray into life as he raced to a commanding lead in the second . The No 3 seed sent over a few glaring looks towards his team before winning the second set . Murray had to put such matters aside as he tackled the unusually talented Thiem, a delight to watch. Coached by Boris Becker's veteran mentor Gunter Bresnik, he slightly resembles Andy Roddick and hits with similar power but more elegance. His single handed backhand is a thing of rare beauty. However, he has had a mediocre season coming into this event and there was little to forewarn of his glorious shotmaking that seemed to catch Murray unawares early on. The world No 4 looked to have worked him out in the second, but then suffered one of his periopdic mental lapses and let him back in from 4-1 before closing it out with a break. After breaking him for 3-1 in the decider the Austrian whirlwind burnt itself out. 'He's a strong guy who hits the ball hard and it became a very physical match,' said Murray. Murray was presented with a celebratory cake after winning his 500th match in the previous round ."</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre> Andy Murray  came close to giving himself some extra preparation time for his w
edding next week before ensuring that he still has unfinished tennis business to
 attend to. The world No 4 is into the semi-finals of the Miami Open, but not be
fore getting a scare from 21 year-old Austrian Dominic Thiem, who pushed him to 
4-4 in the second set before going down 3-6 6-4, 6-1 in an hour and three quarte
rs. Murray was awaiting the winner from the last eight match between Tomas Berdy
ch and Argentina's Juan Monaco. Prior to this tournament Thiem lost in the secon
d round of a Challenger event to soon-to-be new Brit Aljaz Bedene. Andy Murray p
umps his first after defeating Dominic Thiem to reach the Miami Open semi finals
 . Muray throws his sweatband into the crowd after completing a 3-6, 6-4, 6-1 vi
ctory in Florida . Murray shakes hands with Thiem who he described as a 'strong 
guy' after the game . And Murray has a fairly simple message for any of his fell
ow British tennis players who might be agitated about his imminent arrival into 
the home ranks: don't complain. Instead the British No 1 believes his colleagues
 should use the assimilation of the world number 83, originally from Slovenia, a
s motivation to better themselves. At present any grumbles are happening in priv
ate, and Bedene's present ineligibility for the Davis Cup team has made it less 
of an issue, although that could change if his appeal to play is allowed by the 
International Tennis Federation. Murray thinks anyone questioning the move, now 
it has become official, would be better working on getting their ranking closer 
to his. 'If he was 500 in the world they wouldn't be that fussed about it but ob
viously he threatens their position a bit,' said the 27 year-old Scot. ' and he'
s obviously the British number two, comfortably. 'So they can complain but the b
est thing to do is use it in the right way and accept it for what it is, and try
 to use it as motivation whether they agree with it or not. He's British now so 
they've just got to deal with it. Murray stretches for a return after starting h
is quarter final match slowly on the show court . Thiem held nothing back as he 
raced through the opening set, winning it 6-3 with a single break . The young Au
strian is considered to be one of the hottest prospects on the ATP Tour . 'I wou
ld hope that all the guys who are below him now like James (Ward) , Kyle (Edmund
) , Liam (Broady) they will use it as motivation. If he becomes eligible for Dav
is Cup then those guys are going to have to prove themselves. 'It can only be se
en as a positive for those guys using it to try to get better. He's a good playe
r but so are James and Kyle and Liam has improved. Aljaz is there, he's on the t
our every week, the other guys aren't quite there yet.' For the first time Murra
y, who has an encyclopaedic knowledge of the top 100, gave his opinion of Bedene
: 'He's a good player with a very good serve. He's a legitimate top 100 player, 
when he plays Challengers he's there or thereabouts, when he plays on the main t
our he wins matches, it's not like he turns up and always loses in the first rou
nd. Murray's fiancee was once again watching from the stands shaded by a huge br
immed hat . Kim Sears flashes her enormous diamond engagement ring while watchin
g her beau on court . 'He had a bad injury last year (wrist) but has recovered w
ell. I would imagine he would keep moving up the rankings although I don't know 
exactly how high he can go. I've practised with him a couple of times, I haven't
 seen him play loads, but when you serve as well as he does it helps. I would im
agine he' s going to be comfortably in the top 70 or 80 in the world for a while
.' It is understood the Lawn Tennis Association will give background support to 
his case regarding the Davis Cup but have made it clear that the onus is on him 
to lead the way. An official statement said: 'To have another player in the men'
s top 100 is clearly a positive thing for British tennis and so we very much wel
come Aljaz's change in citizenship.' The last comparable switch came twenty year
s ago when Greg Rusedski arrived from Canada. It was by no means universally pop
ular but, like Bedene, he pledged that he was in for the long haul and, in fairn
ess to him, he proved true to his word. Loising the first set shocked Murray int
o life as he raced to a commanding lead in the second . The No 3 seed sent over 
a few glaring looks towards his team before winning the second set . Murray had 
to put such matters aside as he tackled the unusually talented Thiem, a delight 
to watch. Coached by Boris Becker's veteran mentor Gunter Bresnik, he slightly r
esembles Andy Roddick and hits with similar power but more elegance. His single 
handed backhand is a thing of rare beauty. However, he has had a mediocre season
 coming into this event and there was little to forewarn of his glorious shotmak
ing that seemed to catch Murray unawares early on. The world No 4 looked to have
 worked him out in the second, but then suffered one of his periopdic mental lap
ses and let him back in from 4-1 before closing it out with a break. After break
ing him for 3-1 in the decider the Austrian whirlwind burnt itself out. 'He's a 
strong guy who hits the ball hard and it became a very physical match,' said Mur
ray. Murray was presented with a celebratory cake after winning his 500th match 
in the previous round .
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Cut">
<a class="anchor" href="#Cut" aria-hidden="true"><span class="octicon octicon-link"></span></a>Cut<a class="anchor-link" href="#Cut"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote>
<p>Note 
Most of our other models do not make inputs for the user -- that's the tokenizer's job, but as the t5 authors write: &gt; "A major factor that differentiates the architectures is the mask used by different attention mechanisms in the model."</p>
</blockquote>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description" open="">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-show</span>
<span class="n">LONG_BORING_TENNIS_ARTICLE</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2"> Andy Murray has a fairly simple message for any of his fellow British tennis pl</span>
<span class="s2">ayers who might be agitated about the imminent arrival of Aljaz Bedene into the </span>
<span class="s2">home ranks: don’t complain. Instead the British No 1 believes his colleagues sho</span>
<span class="s2">uld use the assimilation of the world No 83, originally from Slovenia, as motiva</span>
<span class="s2">tion to better themselves. At present any grumbles are happening in private, and</span>
<span class="s2"> Bedene’s present ineligibility for the Davis Cup team has made it less of an is</span>
<span class="s2">sue, although that could change if his appeal to play is allowed by the Internat</span>
<span class="s2">ional Tennis Federation. Aljaz Bedene is pictured at his British citizenship cer</span>
<span class="s2">emony in Hatfield on Tuesday morning . Andy Murray says British players anyone q</span>
<span class="s2">uestioning the move should work on their world ranking . Bedene poses for a pict</span>
<span class="s2">ure with friends and family outside the petty sessional court building in Hatfie</span>
<span class="s2">ld . Last year, when Bedene stated he intended to try to make the switch, the th</span>
<span class="s2">en British No 3 Dan Evans expressed some doubts about its legitimacy, wondering </span>
<span class="s2">why he would wish to do it. But Murray thinks anyone questioning the move, now i</span>
<span class="s2">t has become official, would be better working on getting their ranking closer t</span>
<span class="s2">o his. ‘If he was 500 in the world they wouldn’t be that fussed about it but obv</span>
<span class="s2">iously he threatens their position a bit,’ said the 27-year-old Scot. ‘And he’s </span>
<span class="s2">obviously the British No 2, comfortably. ‘So they can complain but the best thin</span>
<span class="s2">g to do is use it in the right way and accept it for what it is, and try to use </span>
<span class="s2">it as motivation whether they agree with it or not. He’s British now so they’ve </span>
<span class="s2">just got to deal with it. ‘I would hope that all the guys who are below him now,</span>
<span class="s2"> like James Ward, Kyle Edmund and Liam Broady, will use it as motivation. If he </span>
<span class="s2">becomes eligible for Davis Cup ties then those guys are going to have to prove t</span>
<span class="s2">hemselves. ‘He’s a good player but so are James and Kyle, and Liam has improved.</span>
<span class="s2"> Aljaz is there, he’s on the tour every week, the other guys aren’t quite there </span>
<span class="s2">yet.’ Murray admits Bedene's stance threatens certain players position as he is </span>
<span class="s2">on tour every week . James Ward (left) and Kyle Edmund should try to use Bedene </span>
<span class="s2">as motivation to get better as a player . Bedene (right) with girlfriend Kimalie</span>
<span class="s2">, who is a pop singer in her native land of Slovenia . For the first time, Murra</span>
<span class="s2">y, who has an encyclopaedic knowledge of the top 100, gave his opinion of Bedene</span>
<span class="s2">: ‘He’s a good player with a very good serve. He’s a legitimate top-100 player, </span>
<span class="s2">when he plays challengers he’s there or thereabouts, when he plays on the main t</span>
<span class="s2">our he wins matches, it’s not like he turns up and always loses in the first rou</span>
<span class="s2">nd. ‘He had a bad (wrist) injury last year but has recovered well. I would imagi</span>
<span class="s2">ne he would keep moving up the rankings, although I don’t know exactly how high </span>
<span class="s2">he can go. I’ve practised with him a couple of times, I haven’t seen him play lo</span>
<span class="s2">ads, but when you serve as well as he does it helps. I would imagine he’s going </span>
<span class="s2">to be comfortably in the top 70 or 80 in the world for a while.’ Bedene can indi</span>
<span class="s2">vidually represent any country he wants where he holds a passport. The Davis Cup</span>
<span class="s2"> is a greyer area as from January 1 playing for two countries in a career was ou</span>
<span class="s2">tlawed and he was picked for the Slovenian squad three times — but he will argue</span>
<span class="s2"> his intentions were clear before then and his citizenship was being held up by </span>
<span class="s2">bureaucratic process. It is understood the Lawn Tennis Association will give sup</span>
<span class="s2">port to his case but have made it clear that the onus is on him to lead the way.</span>
<span class="s2"> An official statement said: ‘To have another player in the men’s top 100 is cle</span>
<span class="s2">arly a positive thing and so we very much welcome Aljaz’s change in citizenship.</span>
<span class="s2">’ Murray says Bedene is a great server who could possibly move up the rankings .</span>
<span class="s2"> Murray gets pumped up on his way to victory over Kevin Anderson at the Miami Op</span>
<span class="s2">en . Murray proudly poses with a cake, saying 'It's an amazing feeling' after wi</span>
<span class="s2">nning his 500th game . Switching nationalities is always a contentious issue in </span>
<span class="s2">any sport and Evans’s questions have some pertinence to them. There is a recent </span>
<span class="s2">precedent, however. Two years ago Australian Brydan Klein switched to represent </span>
<span class="s2">GB by virtue of his mother originally being from Manchester. He subsequently str</span>
<span class="s2">uggled but his form has picked up and he is now ranked 210 in the world to make </span>
<span class="s2">himself the national No 5. Last year that would have guaranteed a Wimbledon wild</span>
<span class="s2">card worth, minimally, a staggering £27,000. However, there is now no automatic </span>
<span class="s2">recommendation for a Championships wildcard for Brits ranked inside the top 250.</span>
<span class="s2"> The last comparable switch came twenty years ago when Greg Rusedski arrived fro</span>
<span class="s2">m Canada. It was by no means universally popular but, like Bedene, he pledged th</span>
<span class="s2">at he was in for the long haul and, in fairness to him, he proved true to his wo</span>
<span class="s2">rd. The Great Britain Davis Cup team celebrate their victory against the USA in </span>
<span class="s2">Glasgow last month .</span>
<span class="s2">"""</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span><span class="s1">''</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It's a fun game to try to match which of the following quotes from the abstract map to which paper:</p>
<ol>
<li>
<blockquote>
<p>While many modern approaches to transfer learning for NLP use a Transformer architecture consisting of only a single “stack” (e.g. for language modeling [GPT2]  or classification and span prediction [BERT]), we found that using a standard encoder-decoder structure achieved good results on both generative and classification tasks.</p>
</blockquote>
</li>
<li>
<blockquote>
<p>The model is pre-trained using three types of language modeling tasks: unidirectional, bidirectional, and sequence-to-sequence prediction.</p>
</blockquote>
</li>
<li>
<blockquote>
<p>We present a denoising autoencoder for pretraining sequence to sequence models, ... it uses a standard Transformer-based neural machine translation architecture.</p>
</blockquote>
</li>
</ol>
<p>Answers: [^1]
 [^1]: Answers: (T5, Oct 24) , (UniLM, Oct. 15) , (Bart, Oct. 29)</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">LONG_BORING_TENNIS_ARTICLE</span> <span class="o">=</span> <span class="s2">" Andy Murray has a fairly simple message for any of his fellow British tennis players who might be agitated about the imminent arrival of Aljaz Bedene into the home ranks: don’t complain. Instead the British No 1 believes his colleagues should use the assimilation of the world No 83, originally from Slovenia, as motivation to better themselves. At present any grumbles are happening in private, and Bedene’s present ineligibility for the Davis Cup team has made it less of an issue, although that could change if his appeal to play is allowed by the International Tennis Federation. Aljaz Bedene is pictured at his British citizenship ceremony in Hatfield on Tuesday morning . Andy Murray says British players anyone questioning the move should work on their world ranking . Bedene poses for a picture with friends and family outside the petty sessional court building in Hatfield . Last year, when Bedene stated he intended to try to make the switch, the then British No 3 Dan Evans expressed some doubts about its legitimacy, wondering why he would wish to do it. But Murray thinks anyone questioning the move, now it has become official, would be better working on getting their ranking closer to his. ‘If he was 500 in the world they wouldn’t be that fussed about it but obviously he threatens their position a bit,’ said the 27-year-old Scot. ‘And he’s obviously the British No 2, comfortably. ‘So they can complain but the best thing to do is use it in the right way and accept it for what it is, and try to use it as motivation whether they agree with it or not. He’s British now so they’ve just got to deal with it. ‘I would hope that all the guys who are below him now, like James Ward, Kyle Edmund and Liam Broady, will use it as motivation. If he becomes eligible for Davis Cup ties then those guys are going to have to prove themselves. ‘He’s a good player but so are James and Kyle, and Liam has improved. Aljaz is there, he’s on the tour every week, the other guys aren’t quite there yet.’ Murray admits Bedene's stance threatens certain players position as he is on tour every week . James Ward (left) and Kyle Edmund should try to use Bedene as motivation to get better as a player . Bedene (right) with girlfriend Kimalie, who is a pop singer in her native land of Slovenia . For the first time, Murray, who has an encyclopaedic knowledge of the top 100, gave his opinion of Bedene: ‘He’s a good player with a very good serve. He’s a legitimate top-100 player, when he plays challengers he’s there or thereabouts, when he plays on the main tour he wins matches, it’s not like he turns up and always loses in the first round. ‘He had a bad (wrist) injury last year but has recovered well. I would imagine he would keep moving up the rankings, although I don’t know exactly how high he can go. I’ve practised with him a couple of times, I haven’t seen him play loads, but when you serve as well as he does it helps. I would imagine he’s going to be comfortably in the top 70 or 80 in the world for a while.’ Bedene can individually represent any country he wants where he holds a passport. The Davis Cup is a greyer area as from January 1 playing for two countries in a career was outlawed and he was picked for the Slovenian squad three times — but he will argue his intentions were clear before then and his citizenship was being held up by bureaucratic process. It is understood the Lawn Tennis Association will give support to his case but have made it clear that the onus is on him to lead the way. An official statement said: ‘To have another player in the men’s top 100 is clearly a positive thing and so we very much welcome Aljaz’s change in citizenship.’ Murray says Bedene is a great server who could possibly move up the rankings . Murray gets pumped up on his way to victory over Kevin Anderson at the Miami Open . Murray proudly poses with a cake, saying 'It's an amazing feeling' after winning his 500th game . Switching nationalities is always a contentious issue in any sport and Evans’s questions have some pertinence to them. There is a recent precedent, however. Two years ago Australian Brydan Klein switched to represent GB by virtue of his mother originally being from Manchester. He subsequently struggled but his form has picked up and he is now ranked 210 in the world to make himself the national No 5. Last year that would have guaranteed a Wimbledon wildcard worth, minimally, a staggering £27,000. However, there is now no automatic recommendation for a Championships wildcard for Brits ranked inside the top 250. The last comparable switch came twenty years ago when Greg Rusedski arrived from Canada. It was by no means universally popular but, like Bedene, he pledged that he was in for the long haul and, in fairness to him, he proved true to his word. The Great Britain Davis Cup team celebrate their victory against the USA in Glasgow last month ."</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>TODO(SS): output of above gets smushed into one line</code></p>
<blockquote>
<p>The Palestinian Authority becomes the 123rd member of the International Criminal Court. The move gives the court jurisdiction over alleged crimes in Palestinian territories. Israel and the United States opposed the Palestinians' efforts to join the body. But Palestinian Foreign Minister Riad al-Malki said it was a move toward greater justice.</p>
</blockquote>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="sshleifer/blog_v2"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog_v2/jupyter/2020/03/06/bart.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog_v2/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog_v2/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog_v2/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>The rants and ravings of Sam Shleifer</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/sshleifer" title="sshleifer"><svg class="svg-icon grey"><use xlink:href="/blog_v2/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/sam_shleifer" title="sam_shleifer"><svg class="svg-icon grey"><use xlink:href="/blog_v2/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
